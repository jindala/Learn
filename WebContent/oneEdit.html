<!DOCTYPE html>
<html>
<head>
  <title>Collaborate</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="realCollab.css">
  	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
    <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <script src='https://cdn.firebase.com/v0/firebase.js'></script>
  <script type="text/javascript" data-app-id="Lei9oAybqAlZ2ii2gZpYxw" src="https://assets.yammer.com/platform/yam.js"></script>
  
  <!-- Include CodeMirror -->
  <link rel="stylesheet" href="codemirror.css" />
  <script src="codemirror.js"></script>

  <!-- Include Firepad -->
  <link rel="stylesheet" href="firepad.css" />
  <script src="firepad.js"></script>
  
  
  
  <style type="text/css">
	.navigationBtn{
	  margin: 0 5px;
  	  display: inline-block;
 	  width:800px;
 	  heigth:700px;
 	  position: relative;
	}
	.firepad {
      width: 700px;
      height: 450px;
      /*background-color: #f62; *//* dark orange background */
    }
    #colorholder {
	  width: 480px;
	  height: 30px;
	  border: 2px solid #424547;
	  margin-top: 5px;
	}
	
	#drawing-canvas {
	  border: 2px solid #999
	}
	
	.colorbox {
	  width: 22px;
	  height: 22px;
	  margin: 1px;
	  display: inline-block;
	  border: 2px solid black;
	}
  </style>
	<script>
	$(document).ready(function(){
		var sPageURL = window.location.search.substring(1);
		var user_id = sPageURL.replace("id=", "");		
		$("#firepad").hide();
		
  		$("#btn_hiw").click(function(event){
    		$("#firepad").slideToggle();
    		$("#drawpad").slideToggle();
    		$("#colorholder").slideToggle();
    		if($("#btn_hiw").html() == "Text Editor") {
    			$("#btn_hiw").html("Draw Editor");
    		}
    		else {
    			$("#btn_hiw").html("Text Editor");
    		}
		});
  		
		yam.getLoginStatus(
				  function(response) {
				    if (response.authResponse) {
				      console.log("logged in");
				      yam.request({
				        url: "https://www.yammer.com/api/v1/users/" + user_id + ".json",     //this is one of many REST endpoints that are available
				        method: "GET",
				        data: {    //use the data object literal to specify parameters, as documented in the REST API section of this developer site
				        	"include_group_memberships":"TRUE"
				        },
				        success: function (user) { //print message response information to the console
					          var replaced_width_src = user.mugshot_url_template.replace("{width}", "100");
					          var replaced_src = replaced_width_src.replace("{height}", "100");
				        	$("#content_right").append('<div id="chef_profile" class="chef_class"><img src="'+ replaced_src +'" alt="Name" class="profile_img"><p>'+ user.full_name +'</p></div>');			

				        },
				        error: function (user) {
				          alert("There was an error with the request.");
				        }
				      });
				    }
				    else {
				        yam.login(function (response) { //prompt user to login and authorize your app, as necessary
				            if (response.authResponse) {
				              console.dir(response); //print user information to the console
				            }
				          });
				    }
				  }
				);
	});
	</script>

</head>
<body>
    	<div id="header_color">
			<div id="header_wrapper">
				<div id="header">
					<a href="RealCollab/YammerLogin.html"><img src="images/logo_comp.jpg" alt="RealCollab Logo"></a>
				</div>
			</div>
		</div>
		<div id="wrapper">
			<div id="content">
				<div id="canvas_content_left">
				    <div class="content_tags_body" id="navigationBar">
						<button id="btn_hiw">Text Editor</button>
					</div>
				    
				    <!--div id="drawing_tools" class="tools_class">
				    	<div id="rightArrow" >
							<img src="images/rightArrow.tiff"/>
						</div>
					</div>-->
									
				    <div id="drawpad">
				    	<canvas id="drawing-canvas" width="980" height="850"></canvas>
				    </div>
				    <div id="colorholder"></div>
				    
				    <div id="firepad" style="border: 2px solid #999;width:980px;height:850px;clear:both;"></div>
				 </div>
				 <div id="content_right">
				 <p><h2>Collaborating with:</h2></p>
				 </div>
			</div>
		</div>
    
    <script>
      var myDataRef = new Firebase('https://cpsh7qsnpsa.firebaseio-demo.com/');
	  var editDataRef;
	  
	  //Initialize Firebase
	  var firepadRef = new Firebase('https://realcollaboration.firebaseio.com/');
	  var firepadDiv = document.getElementById('firepad');
	  
	  //Create CodeMirror
	  var codeMirror = CodeMirror(firepadDiv, { lineWrapping: true });
	  
	  //Create Firepad (with rich text toolbar and shortcuts enabled)
	  var firepad = Firepad.fromCodeMirror(firepadRef, codeMirror,
	      { richTextShortcuts: true, richTextToolbar: true });
	  
      /*$('#messageInput').keypress(function (e) {
        if (e.keyCode == 13) {
          var name = $('#nameInput').val();
          var text = $('#messageInput').val();
          //myDataRef.set('User ' + name + ' says ' + text);
          editDataRef = myDataRef.push({name: name, text: text});
          $('#messageInput').val('');
        }
      });
 
      myDataRef.on('child_added', function(snapshot) {
        var message = snapshot.val();
        //alert("push ref: " + editDataRef);
        //alert("tostring: " + message.toString());
        //alert("valueof: " + message.valueOf());
		displayChatMessage(message.name, message.text);
      });

      function displayChatMessage(name, text) {
        $('<div/>').text(text).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
        $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
      };*/
      
      firepad.on('ready', function() {
          if (firepad.isHistoryEmpty()) {
            var f = Firepad.Formatting().fontSize(24);
            firepad.setText([
              Firepad.Text("Rich-text", f.italic(true).color('green')),
              Firepad.Text(" editing with ", f),
              Firepad.Text("Firepad!", f.color('red'))
            ]);
          }
        });
      
      //Drawing canvas
	  //$(document).ready(function () {
	    //Set up some globals
	    var pixSize = 2, lastPoint = null, currentColor = "000", mouseDown = 0;
	
	    //Create a reference to the pixel data for our drawing.
	    var pixelDataRef = new Firebase('https://realcollaboration.firebaseio.com/');
	
	    // Set up our canvas
	    var myCanvas = document.getElementById('drawing-canvas');
	    var myContext = myCanvas.getContext ? myCanvas.getContext('2d') : null;
	    if (myContext == null) {
	      alert("You must use a browser that supports HTML5 Canvas to run this demo.");
	      return;
	    }
	
	    //Setup each color palette & add it to the screen
	    var colors = ["fff","000","f00","0f0","00f","88f","f8d","f88","f05","f80","0f8","cf0","08f","408","ff8","8ff"];
	    for (c in colors) {
	      var item = $('<div/>').css("background-color", '#' + colors[c]).addClass("colorbox");
	      item.click((function () {
	        var col = colors[c];
	        return function () {
	          currentColor = col;
	        };
	      })());
	      item.appendTo('#colorholder');
	    }
	
	    //Keep track of if the mouse is up or down
	    myCanvas.onmousedown = function () {mouseDown = 1;};
	    myCanvas.onmouseout = myCanvas.onmouseup = function () {
	      mouseDown = 0, lastPoint = null;
	    };
	
	    //Draw a line from the mouse's last position to its current position
	    var drawLineOnMouseMove = function(e) {
	      if (!mouseDown) return;
	
	      // Bresenham's line algorithm. We use this to ensure smooth lines are drawn
	      var offset = $('canvas').offset();
	      var x1 = Math.floor((e.pageX - offset.left) / pixSize - 1),
	        y1 = Math.floor((e.pageY - offset.top) / pixSize - 1);
	      var x0 = (lastPoint == null) ? x1 : lastPoint[0];
	      var y0 = (lastPoint == null) ? y1 : lastPoint[1];
	      var dx = Math.abs(x1 - x0), dy = Math.abs(y1 - y0);
	      var sx = (x0 < x1) ? 1 : -1, sy = (y0 < y1) ? 1 : -1, err = dx - dy;
	      while (true) {
	        //write the pixel into Firebase, or if we are drawing white, remove the pixel
	        pixelDataRef.child(x0 + ":" + y0).set(currentColor === "fff" ? null : currentColor);
	
	        if (x0 == x1 && y0 == y1) break;
	        var e2 = 2 * err;
	        if (e2 > -dy) {
	          err = err - dy;
	          x0 = x0 + sx;
	        }
	        if (e2 < dx) {
	          err = err + dx;
	          y0 = y0 + sy;
	        }
	      }
	      lastPoint = [x1, y1];
	    }
	    $(myCanvas).mousemove(drawLineOnMouseMove);
	    $(myCanvas).mousedown(drawLineOnMouseMove);
	
	    // Add callbacks that are fired any time the pixel data changes and adjusts the canvas appropriately.
	    // Note that child_added events will be fired for initial pixel data as well.
	    var drawPixel = function(snapshot) {
	      var coords = snapshot.name().split(":");
	      myContext.fillStyle = "#" + snapshot.val();
	      myContext.fillRect(parseInt(coords[0]) * pixSize, parseInt(coords[1]) * pixSize, pixSize, pixSize);
	    }
	    var clearPixel = function(snapshot) {
	      var coords = snapshot.name().split(":");
	      myContext.clearRect(parseInt(coords[0]) * pixSize, parseInt(coords[1]) * pixSize, pixSize, pixSize);
	    }
	    pixelDataRef.on('child_added', drawPixel);
	    pixelDataRef.on('child_changed', drawPixel);
	    pixelDataRef.on('child_removed', clearPixel);
	  //});
    </script>
</body>
</html>